<div class="comments-info">
  <p class="comments-left">Comments: {{ post.comment_set.all.count }}</p>

  {# like button #}
  <button
      class="btn-like"
      data-api-like-url="{{ post.get_api_like_url }}"
  >
    {% if user in post.likes.all %}
      {{ post.likes.count }} Unlike
    {% else %}
      {{ post.likes.count }} Like
    {% endif %}
  </button>

  <a href="" class="save gray-link" data-api-save-url="{{ post.get_api_save_url }}">
    {% if user in post.saved_by.all %}
      Unsave
    {% else %}
      Save
    {% endif %}
  </a>

  {% if user.is_authenticated %}
    <p class="comments-right">Logged in as <a href="{% url 'profile' user.pk %}" class="gray-link">{{ user.username }}</a></p>
  {% endif %}
</div>

<div class="comments">
  {# comment form #}
  {% if user.is_authenticated %}
    <form method="post" action="." class="comment-form">
      {% csrf_token %}
      {{ form }}
      <input type="submit" value="Post" class="btn-small btn-blue">
    </form>
  {% else %}
    <a href="{% url 'login' %}?next={{ request.path }}"><p>Log in to comment</p></a>
  {% endif %}

  <div class="comment-block">
    {% if post.comment_set.all %}
      {% for comment in post.comment_set.all %}
        {# display only comments which are not replies #}
        {% if not comment.parent %}
          <div class="comment">
            <div class="avatar">
              <img src="{{ comment.user.profile.image.url }}" class="profile-pic-thumbnail">
            </div>
            <div class="comment-rest">

              <div class="edit-hide">
                <div class="comment-above">
                  Posted by <a href="{% url 'profile' comment.user.pk %}" class="gray-link">{{ comment.user }}</a>
                  {{ comment.published|timesince }} ago
                </div>
                <p>{{ comment.text }}</p>
                <div class="comment-below">
                  {% if comment.user == user %}
                    <a href="#" class="comment-edit">edit</a>
                    <a href="#" class="comment-delete">delete</a>
                    <div class="comment-delete-confirmation">
                      <span>Are you sure? </span>
                      <form method="post" action="." class="comment-delete-form">
                        {% csrf_token %}
                        <input type="hidden" name="comment_id" value="{{ comment.id }}">
                        <input type="hidden" name="delete" value="True">
                        <span><a href="#" class="yes">Yes</a></span>
                      </form>
                      <span> / </span><a href="#" class="no">No</a>
                    </div>
                  {% endif %}
                  {% if user.is_authenticated %}
                    <button class="btn-like reply-btn">Reply</button>
                  {% endif %}
                </div>

                <form method="post" action="." class="reply-form">
                  {% csrf_token %}
                  <input type="hidden" name="parent_id" value="{{ comment.id }}">
                  {{ form }}
                  <div class="edit-buttons">
                    <input type="submit" value="Post" class="comment-edit-save btn-small btn-blue">
                    <button type="button" class="comment-cancel btn-small btn-gray">Cancel</button>
                  </div>
                </form>

              </div>
              {# show comment edit form on click #}
              <form method="post" action="." class="comment-edit-form">
                {% csrf_token %}
                <input type="hidden" name="comment_id" value="{{ comment.id }}">
                <input type="hidden" name="edit" value="True">
                {{ form }}
                <div class="edit-buttons">
                  <input type="submit" value="Save" class="comment-edit-save btn-small btn-blue">
                  <button type="button" class="comment-cancel btn-small btn-gray">Cancel</button>
                </div>
              </form>

              <div class="replies">
                {% for child in comment.children.all %}
                  <div class="comment comment-reply">
                    <div class="avatar">
                      <img src="{{ child.user.profile.image.url }}" class="profile-pic-thumbnail">
                    </div>
                    <div class="comment-rest">
                      <div class="edit-hide">
                        <div class="comment-above">
                          Posted by <a href="{% url 'profile' child.user.pk %}" class="gray-link">{{ child.user }}</a>
                          {{ child.published|timesince }} ago
                        </div>
                        <p>{{ child.text }}</p>
                        <div class="comment-below">
                          {% if child.user == user %}
                            <a href="#" class="comment-edit">edit</a>
                            <a href="#" class="comment-delete">delete</a>
                            <div class="comment-delete-confirmation">
                              <span>Are you sure? </span>
                              <form method="post" action="." class="comment-delete-form">
                                {% csrf_token %}
                                <input type="hidden" name="comment_id" value="{{ child.id }}">
                                <input type="hidden" name="delete" value="True">
                                <span><a href="#" class="yes">Yes</a></span>
                              </form>
                              <span> / </span><a href="#" class="no">No</a>
                            </div>
                          {% endif %}
                        </div>
                      </div>
                      {# show comment edit form on click #}
                      <form method="post" action="." class="comment-edit-form">
                        {% csrf_token %}
                        <input type="hidden" name="comment_id" value="{{ child.id }}">
                        <input type="hidden" name="edit" value="True">
                        {{ form }}
                        <div class="edit-buttons">
                          <input type="submit" value="Save" class="comment-edit-save btn-small btn-blue">
                          <button type="button" class="comment-cancel btn-small btn-gray">Cancel</button>
                        </div>
                      </form>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    {% else %}
      <p class="no-comments">No comments yet</p>
    {% endif %}
  </div>
</div>